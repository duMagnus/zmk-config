#include "mod_logo32.h"

#include <lvgl.h>

#include <zephyr/sys/util.h> // ARG_UNUSED
#include "portrait_demo.h"

// 32x32, 1bpp, MSB-first per byte, 4 bytes per row.
static const uint8_t logo_left_32x32[32][4] = {
    {0b11111111, 0b11111111, 0b11111111, 0b11111111},
    {0b11111111, 0b11111111, 0b11111111, 0b11111101},
    {0b11111111, 0b11111111, 0b11111111, 0b10111011},
    {0b11111111, 0b11111111, 0b11111111, 0b01101111},
    {0b11111111, 0b11111111, 0b11111110, 0b01111111},
    {0b11111001, 0b00000011, 0b11111000, 0b01111111},
    {0b11111000, 0b00110000, 0b00110000, 0b11111111},
    {0b11110000, 0b10011100, 0b11100001, 0b11101111},
    {0b11100000, 0b01011010, 0b11001111, 0b11111111},
    {0b11000000, 0b01111111, 0b11111111, 0b11011111},
    {0b11000000, 0b11111111, 0b10111111, 0b10111111},
    {0b11001011, 0b11111111, 0b01101011, 0b11111111},
    {0b11011111, 0b11111111, 0b00100001, 0b11111111},
    {0b11011101, 0b11111111, 0b11011001, 0b00111111},
    {0b11110001, 0b10111111, 0b11111100, 0b00111111},
    {0b11010011, 0b10111111, 0b11111101, 0b01011111},
    {0b11000001, 0b11111111, 0b11111100, 0b01111111},
    {0b11000011, 0b00111111, 0b11111110, 0b11001111},
    {0b11000011, 0b11101111, 0b11111101, 0b10111111},
    {0b11000011, 0b11110111, 0b11111111, 0b01100011},
    {0b11001111, 0b10110100, 0b01110101, 0b00101001},
    {0b11011111, 0b10000011, 0b11101111, 0b11111111},
    {0b10111111, 0b11010100, 0b11111101, 0b10010111},
    {0b00111111, 0b10110001, 0b11111111, 0b11101001},
    {0b00111111, 0b11011010, 0b11111111, 0b11101001},
    {0b00111111, 0b00111111, 0b11110111, 0b11111101},
    {0b00011111, 0b10001111, 0b11111111, 0b11111010},
    {0b00001111, 0b11111111, 0b11011111, 0b11111110},
    {0b00000000, 0b11111111, 0b11101111, 0b11110101},
    {0b00010000, 0b01111111, 0b11111111, 0b11111010},
    {0b00000000, 0b00001100, 0b11111111, 0b11101100},
    {0b00000000, 0b00110111, 0b11111111, 0b11111111},
};

static const uint8_t logo_right_32x32[32][4] = {
    // For now: same image.
    {0b11111111, 0b11111111, 0b11111111, 0b11111111},
    {0b11111111, 0b11111111, 0b11111111, 0b11111111},
    {0b11111111, 0b11111111, 0b11111111, 0b11101011},
    {0b11111111, 0b11111111, 0b11111111, 0b11101111},
    {0b10011111, 0b11111111, 0b11111111, 0b10101011},
    {0b11010111, 0b11111111, 0b11111110, 0b11010111},
    {0b11010111, 0b11111111, 0b11111111, 0b01111111},
    {0b10101001, 0b11111111, 0b11111010, 0b11010111},
    {0b11110111, 0b01111110, 0b00101001, 0b11110111},
    {0b10101111, 0b11010100, 0b00001010, 0b11010111},
    {0b11011011, 0b11110010, 0b00010101, 0b11111111},
    {0b11101011, 0b01110100, 0b00000111, 0b10101111},
    {0b11101110, 0b11110100, 0b00101010, 0b11101111},
    {0b11110111, 0b01101010, 0b00001111, 0b11110111},
    {0b11110101, 0b11111100, 0b00011110, 0b10011111},
    {0b11111011, 0b11011101, 0b10000110, 0b11101011},
    {0b11111011, 0b11011101, 0b10000110, 0b11101011},
    {0b11110101, 0b01110100, 0b00000111, 0b11110111},
    {0b11111011, 0b11011010, 0b00100010, 0b11010111},
    {0b11111011, 0b10100100, 0b00001011, 0b11110111},
    {0b11111111, 0b11101000, 0b01010010, 0b11011111},
    {0b11110110, 0b10110100, 0b00111101, 0b11101111},
    {0b11111110, 0b11101010, 0b01111001, 0b01110111},
    {0b11110111, 0b01101100, 0b00111101, 0b10110111},
    {0b11110101, 0b10110101, 0b11111101, 0b11010111},
    {0b11111011, 0b11010100, 0b00111011, 0b01101011},
    {0b11111110, 0b01000101, 0b11101101, 0b10100111},
    {0b11111101, 0b00100001, 0b10111010, 0b10101011},
    {0b11111110, 0b10010101, 0b10101010, 0b10100111},
    {0b11111100, 0b01000101, 0b10101010, 0b01010111},
    {0b11111101, 0b00010010, 0b00001001, 0b00100111},
    {0b11111000, 0b01000101, 0b11010100, 0b10010011},
};

static const uint8_t (*get_logo_rows(void))[4] {
#if defined(CONFIG_ZMK_SPLIT) && defined(CONFIG_ZMK_SPLIT_ROLE_CENTRAL)
    return logo_left_32x32;
#elif defined(CONFIG_ZMK_SPLIT) && defined(CONFIG_ZMK_SPLIT_ROLE_PERIPHERAL)
    return logo_right_32x32;
#else
    // Non-split / unknown role: just use left
    return logo_left_32x32;
#endif
}

static void draw_1bpp_icon_32x32(lv_obj_t *canvas, int x, int y, const uint8_t rows[32][4]) {
    for (int row = 0; row < 32; row++) {
        for (int col = 0; col < 32; col++) {
            const uint8_t byte = rows[row][col >> 3];
            const int bit = (byte >> (7 - (col & 7))) & 1;
            if (bit) {
                lv_canvas_set_px(canvas, x + col, y + row, lv_color_white());
                lv_canvas_set_px_opa(canvas, x + col, y + row, LV_OPA_COVER);
            }
        }
    }
}

void logo32_module_init(logo32_module_t *m, uint16_t x, uint16_t y) {
    if (!m) {
        return;
    }
    m->x = x;
    m->y = y;
}

void logo32_module_draw(const logo32_module_t *m,
                        const render_ctx_t *ctx,
                        const screen_state_t *state) {
    ARG_UNUSED(state);

    if (!m || !ctx || !ctx->portrait_canvas) {
        return;
    }

    const uint8_t (*rows)[4] = get_logo_rows();
    draw_1bpp_icon_32x32(ctx->portrait_canvas, (int)m->x, (int)m->y, rows);
}
